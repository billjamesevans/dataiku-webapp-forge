{% extends "base.html" %}
{% block content %}
  <section class="card">
    <div class="card-header">
      <h2>Export</h2>
      <div class="muted">Download a zip, then paste the files into a Dataiku Standard WebApp.</div>
    </div>
    <div class="card-body">
      <div class="actions" style="justify-content:flex-start;">
        <a class="btn btn-primary" href="{{ url_for('project_export_zip', project_id=project.id) }}">Download Zip</a>
      </div>

      <h3 class="section-title" style="margin-top:14px;">Generated Files</h3>
      <div class="hint">These are exactly what will be inside the zip.</div>

      {% for a in apps %}
        {% set app_idx = loop.index0 %}
        <details class="details" {% if loop.first %}open{% endif %}>
          <summary class="summary">
            <span class="mono">{{ a.slug }}</span>
            <span class="muted">{{ a.title }}</span>
          </summary>
          {% for fname, content in a.files.items() %}
            {% set code_id = "code-" ~ app_idx ~ "-" ~ loop.index0 %}
            <details class="details file">
              <summary class="summary">
                <span class="mono">{{ fname }}</span>
                <button class="btn btn-small copy-btn" type="button" data-copy-target="{{ code_id }}">Copy</button>
              </summary>
              <pre id="{{ code_id }}" class="code"><code>{{ content }}</code></pre>
            </details>
          {% endfor %}
        </details>
      {% endfor %}
    </div>
  </section>

  <script>
    (function () {
      async function copyText(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          return;
        }
        var ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
      }

      document.addEventListener('click', function (e) {
        var btn = e.target.closest('[data-copy-target]');
        if (!btn) return;
        // Prevent toggling the details element when clicking inside <summary>.
        e.preventDefault();
        e.stopPropagation();
        var id = btn.getAttribute('data-copy-target');
        var el = id ? document.getElementById(id) : null;
        if (!el) return;

        var text = el.textContent || '';
        var prev = btn.textContent;
        copyText(text)
          .then(function () {
            btn.textContent = 'Copied';
            setTimeout(function () { btn.textContent = prev; }, 1200);
          })
          .catch(function () {
            btn.textContent = 'Failed';
            setTimeout(function () { btn.textContent = prev; }, 1200);
          });
      });
    })();
  </script>
{% endblock %}
